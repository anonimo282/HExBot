(function(){const LAST_COMMAND_TERMINATED="lastCommandTerminated",PAGE_IS_ABOUT_TO_RELOAD="beforeunload",SEQUENCE_TERMINATED="terminated",SEQUENCE_RESET="reset",STORAGE_NAME='"jSpaghetti:" + moduleName + ":" + sequenceName',EXIT_COMMAND="_exit",GOTOIF_COMMAND="gotoif",WAIT_COMMAND="wait",WAIT_FOR_THE_SIGNAL_FLAG="_forTheSignal",WAIT_FOR_PAGE_TO_RELOAD="_forPageToReload",INTERNAL_OBJECT_COMMANDS_LIST=[WAIT_COMMAND,GOTOIF_COMMAND],DEFAULT_DELAY=10;function Route(e,t){this.instruction=e,this.command=t}function State(e,t,n,u){this.route=e,this.shared=t,this.lastProcedureRoute=n,this.callLastProcedure=u}function getFirstAttribName(e){return Object.keys(e)[0]}function getInstructionByRoute(e,t){var n=getFirstAttribName(e[t.instruction]);return{label:n,commands:e[t.instruction][n]}}function getCommandByRoute(e,t){return getInstructionByRoute(e,t).commands[t.command]}function getNextRoute(e,t){var n=getInstructionByRoute(e,t).commands,u=new Route(t.instruction,t.command);return t.command<n.length-1?u.command+=1:t.instruction<e.length-1?(u.instruction+=1,u.command=0):u=null,u}function getInstructionPosByLabel(e,t){for(var n=0;n<t.length;n++)if(t[n].hasOwnProperty(e))return n;return!1}function checkInstructionsSyntax(e,t){if(e.length>0){for(var n=0;n<e.length;n++){var u=getFirstAttribName(e[n]);"[object Array]"!=Object.prototype.toString.call(e[n][u])&&(e[n][u]=[e[n][u]]);for(var r=0;r<e[n][u].length;r++)switch(typeof e[n][u][r]){case"object":var s=getFirstAttribName(e[n][u][r]);if(-1==INTERNAL_OBJECT_COMMANDS_LIST.indexOf(s))return'Internal command "'+s+'" is undefined';var a=e[n][u][r][s];if(s==WAIT_COMMAND){if("object"==typeof a){var o=getFirstAttribName(a);if(o!=WAIT_FOR_THE_SIGNAL_FLAG)return'Label "'+o+'" is undefined';if(!t.hasOwnProperty(a[o]))return'Procedure "'+a[o]+'" is undefined'}}else if(s==GOTOIF_COMMAND){if("[object Array]"!=Object.prototype.toString.call(a))return'Internal command "'+s+'" must receive an array';if(a.length<2)return'Internal command "'+s+'" must receive an array that must have at least 2 positions';for(var c=1;c<a.length;c++){var i=a[c];if(!1===getInstructionPosByLabel(i,e)&&i!=EXIT_COMMAND)return'Instruction label "'+i+'" is undefined'}}break;default:var l=e[n][u][r];if(!t.hasOwnProperty(l)&&l!=EXIT_COMMAND)return'Procedure "'+l+'" is undefined'}}return!0}return"There are no instructions to be executed"}function throwErrorNotification(e,t){console.error("jSpaghetti error:",e,t)}function showDebugMessage(e,t){console.log("jSpaghetti debug:",e,t)}function evaluateExpression(expression,shared){const STORAGETOKEN=/\*|SHARED/g;expression=String(expression).replace(STORAGETOKEN,"shared");var result=eval(expression);return result}function startSignalListener(e,t){var n=jSpaghetti.modules[e].sequences[t],u=setInterval((function(){(!n.state.route||null!=n.signalChannel&&jSpaghetti.state.ready)&&(clearInterval(u),n.state.route?(jSpaghetti.modules[e].config.debugMode&&showDebugMessage("Roger! ("+e+":"+t+"): ",n.signalChannel),n.state.shared.$=n.signalChannel,n.signalChannel=null,n.state.callLastProcedure=!1):jSpaghetti.modules[e].config.debugMode&&showDebugMessage("Signal listener was abruptly interrupted ("+e+":"+t+")"," "),jSpaghetti.modules[e].sequences[t].run(n.state))}),DEFAULT_DELAY)}function getSharedFunctions(e,t){return{sendSignal:function(n){null==n&&(n="Empty message"),jSpaghetti.modules[e].config.debugMode&&showDebugMessage("Signal sent ("+e+":"+t+"): ",n),jSpaghetti.modules[e].sequences[t].signalChannel=n},next:function(n){jSpaghetti.modules[e].config.debugMode&&showDebugMessage("Next called ("+e+":"+t+"): ",n),jSpaghetti.modules[e].sequences[t].state.shared.$=n,jSpaghetti.modules[e].sequences[t].events.dispatchEvent(getEvent(LAST_COMMAND_TERMINATED))},getObjectSnapshot:getObjectSnapshot}}function dispatchExitCommand(e,t){jSpaghetti.modules[e].sequences[t].state.route=null,jSpaghetti.modules[e].config.debugMode&&showDebugMessage("Exit command dispatched ("+e+":"+t+")"," ")}function getObjectSnapshot(e){return"object"==typeof e&&JSON.parse(JSON.stringify(e))}function getEvent(e){return new Event(e)}function startStateSaver(){window.addEventListener(PAGE_IS_ABOUT_TO_RELOAD,(function(event){for(var moduleName in jSpaghetti.state.ready=!1,jSpaghetti.modules)for(var sequenceName in jSpaghetti.modules[moduleName].sequences){var localStorage=new jSpaghetti.Storage(eval(STORAGE_NAME));localStorage.set(jSpaghetti.modules[moduleName].sequences[sequenceName].state,(function(){}))}}))}function runAssyncronously(e){setTimeout((function(){e()}),0)}var jSpaghetti={state:{ready:!0,running:!1},version:"0.1.6",modules:{},module:function(moduleName){var currentModule=jSpaghetti.modules[moduleName],module={name:moduleName,config:{debugMode:!1,developerMode:!1},sequences:{},procedures:{},procedure:function(e,t){currentModule.procedures[e]=t},sequence:function(sequenceName){var currentSequence=currentModule.sequences[sequenceName],initialRoute=new Route(0,0),initialState=new State(initialRoute,{$:void 0},null,!1),sequence={name:sequenceName,module:currentModule,events:document.createDocumentFragment(),state:initialState,signalChannel:null,instructions:[],run:function(lastState){setTimeout((function(){if(jSpaghetti.state.ready){jSpaghetti.state.running||(jSpaghetti.state.running=!0,startStateSaver());var resultSyntaxCheck=checkInstructionsSyntax(currentSequence.instructions,currentModule.procedures),runNextCommand=function(e){if(e&&(currentSequence.state=e),currentSequence.state.route&&!0===resultSyntaxCheck){currentSequence.state.callLastProcedure&&(currentSequence.state.callLastProcedure=!1,currentSequence.state.route=currentSequence.state.lastProcedureRoute);var t=getCommandByRoute(currentSequence.instructions,currentSequence.state.route),n=currentSequence.state.route.command,u=getInstructionByRoute(currentSequence.instructions,currentSequence.state.route).label,r=getNextRoute(currentSequence.instructions,currentSequence.state.route);switch(typeof t){case"object":switch(Object.keys(t)[0]){case WAIT_COMMAND:if("object"==typeof t[WAIT_COMMAND])switch(getFirstAttribName(t[WAIT_COMMAND])){case WAIT_FOR_THE_SIGNAL_FLAG:currentSequence.state.lastProcedureRoute=new Route(currentSequence.state.route.instruction,currentSequence.state.route.command),currentSequence.state.callLastProcedure=!0,currentSequence.state.route=r,startSignalListener(moduleName,sequenceName),currentModule.config.debugMode&&showDebugMessage("Waiting for the signal and running command",'"'+moduleName+":"+sequenceName+":"+u+":"+n+":"+t[WAIT_COMMAND][WAIT_FOR_THE_SIGNAL_FLAG]+'"'),runAssyncronously((function(){currentSequence.state.shared.$=currentModule.procedures[t[WAIT_COMMAND][WAIT_FOR_THE_SIGNAL_FLAG]](currentSequence.state.shared,getSharedFunctions(moduleName,sequenceName))}))}else if(t[WAIT_COMMAND]==WAIT_FOR_THE_SIGNAL_FLAG)currentSequence.state.callLastProcedure=!0,currentSequence.state.route=r,startSignalListener(moduleName,sequenceName),currentModule.config.debugMode&&showDebugMessage("Waiting for the signal ("+moduleName+":"+sequenceName+":"+u+":"+n+")"," ");else if(t[WAIT_COMMAND]==WAIT_FOR_PAGE_TO_RELOAD)currentSequence.state.route=r,currentModule.config.debugMode&&showDebugMessage("Waiting for page to reload ("+moduleName+":"+sequenceName+":"+u+":"+n+")"," ");else{var s=evaluateExpression(t[WAIT_COMMAND],currentSequence.state.shared);currentModule.config.debugMode&&showDebugMessage("Waiting "+s+" ms ("+moduleName+":"+sequenceName+":"+u+":"+n+")"," ");var a=0,o=setInterval((function(){a++,(!currentSequence.state.route||a>=s/DEFAULT_DELAY)&&(clearInterval(o),currentSequence.state.route?currentSequence.state.route=r:currentModule.config.debugMode&&showDebugMessage("Wait process was abruptly interrupted ("+moduleName+":"+sequenceName+")"," "),currentModule.sequences[sequenceName].events.dispatchEvent(getEvent(LAST_COMMAND_TERMINATED)))}),DEFAULT_DELAY)}break;case GOTOIF_COMMAND:if(evaluateExpression(t[GOTOIF_COMMAND][0],currentSequence.state.shared))if(currentModule.config.debugMode&&showDebugMessage("Gotoif returned true ("+moduleName+":"+sequenceName+":"+u+":"+n+")"," "),t[GOTOIF_COMMAND][1]!=EXIT_COMMAND){var c=t[GOTOIF_COMMAND][1];currentSequence.state.route.command=0,currentSequence.state.route.instruction=getInstructionPosByLabel(t[GOTOIF_COMMAND][1],currentSequence.instructions)}else dispatchExitCommand(moduleName,sequenceName);else if(currentModule.config.debugMode&&showDebugMessage("Gotoif returned false ("+moduleName+":"+sequenceName+":"+u+":"+n+")"," "),t[GOTOIF_COMMAND].length>2)if(t[GOTOIF_COMMAND][2]!=EXIT_COMMAND){c=t[GOTOIF_COMMAND][2];currentSequence.state.route.command=0,currentSequence.state.route.instruction=getInstructionPosByLabel(t[GOTOIF_COMMAND][2],currentSequence.instructions)}else dispatchExitCommand(moduleName,sequenceName);else currentSequence.state.route=r;c&&currentModule.config.debugMode&&showDebugMessage('Flow redirected to "'+c+'" ('+moduleName+":"+sequenceName+")"," "),currentModule.sequences[sequenceName].events.dispatchEvent(getEvent(LAST_COMMAND_TERMINATED))}break;default:t!=EXIT_COMMAND?(currentSequence.state.lastProcedureRoute=new Route(currentSequence.state.route.instruction,currentSequence.state.route.command),currentSequence.state.route=r,currentModule.config.debugMode&&showDebugMessage("Running command",'"'+moduleName+":"+sequenceName+":"+u+":"+n+":"+t+'"'),runAssyncronously((function(){const e=currentModule.procedures[t](currentSequence.state.shared,getSharedFunctions(moduleName,sequenceName));void 0!==e&&(currentSequence.state.shared.$=e,currentModule.sequences[sequenceName].events.dispatchEvent(getEvent(LAST_COMMAND_TERMINATED)))}))):(dispatchExitCommand(moduleName,sequenceName),currentModule.sequences[sequenceName].events.dispatchEvent(getEvent(LAST_COMMAND_TERMINATED)))}}else!0!==resultSyntaxCheck&&throwErrorNotification(resultSyntaxCheck+" ("+moduleName+":"+sequenceName+")"," "),null==currentSequence.state.route&&(currentModule.config.debugMode&&showDebugMessage("Sequence is terminated ("+moduleName+":"+sequenceName+")"," "),currentSequence.events.dispatchEvent(getEvent(SEQUENCE_TERMINATED)))};if(lastState)currentModule.config.developerMode&&showDebugMessage("Data recovered from the last state ("+moduleName+":"+sequenceName+"): ",getObjectSnapshot(currentSequence.state)),runNextCommand(lastState);else{var localStorage=new jSpaghetti.Storage(eval(STORAGE_NAME));localStorage.get((function(e){e?currentModule.config.developerMode&&showDebugMessage("Data recovered from the local storage ("+moduleName+":"+sequenceName+"): ",getObjectSnapshot(currentSequence.state)):currentModule.config.developerMode&&showDebugMessage("Data recovered from the initial state ("+moduleName+":"+sequenceName+"): ",getObjectSnapshot(currentSequence.state)),runNextCommand(e)}))}}else currentModule.config.developerMode&&showDebugMessage("jSpaghetti is not ready: Probably the page is about to be reloaded ("+moduleName+":"+sequenceName+")"," ")}),DEFAULT_DELAY)},reset:function(callback){currentSequence.state.route=null,setTimeout((function(){var routeReseted=new Route(0,0);currentSequence.state=new State(routeReseted,{$:void 0},null,!1);var localStorage=new jSpaghetti.Storage(eval(STORAGE_NAME));localStorage.reset((function(){callback&&callback(currentSequence)})),currentModule.config.debugMode&&showDebugMessage("Sequence is reset ("+moduleName+":"+sequenceName+")"," "),currentSequence.events.dispatchEvent(getEvent(SEQUENCE_RESET))}),5*DEFAULT_DELAY)}};return sequence.events.addEventListener(LAST_COMMAND_TERMINATED,(e=>{e.stopPropagation(),currentModule.config.developerMode&&showDebugMessage("Last command terminated event dispatched ("+moduleName+":"+sequenceName+"): ",getObjectSnapshot(currentSequence.state)),currentModule.sequences[sequenceName].run(currentSequence.state)})),null==currentSequence&&(currentModule.sequences[sequenceName]=sequence,currentSequence=currentModule.sequences[sequenceName]),currentModule.sequences[sequenceName]}};return null==currentModule&&(jSpaghetti.modules[moduleName]=module,currentModule=jSpaghetti.modules[moduleName]),currentModule},Storage:function(e){this.get=function(t){t&&runAssyncronously((function(){t(JSON.parse(sessionStorage.getItem(e)))}))},this.set=function(t,n){n&&runAssyncronously(n),sessionStorage.setItem(e,JSON.stringify(t))},this.reset=function(t){t&&runAssyncronously(t),sessionStorage.removeItem(e)}}};$jSpaghetti=jSpaghetti})();